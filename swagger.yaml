openapi: 3.0.3
info:
  title: Museum Aceh - Inventory & Berita Acara API
  description: |
    API backend untuk sistem inventaris Museum Aceh dan pencatatan
    **Berita Acara Serah Terima / Pengembalian Koleksi**.

    ## Autentikasi
    Semua endpoint (kecuali `/auth/login` dan `/auth/register`) membutuhkan **Bearer Token**.
    Klik tombol **Authorize** dan masukkan token dengan format: `Bearer <token>`

    ## Alur Penggunaan
    1. `POST /auth/login` → dapatkan token
    2. `POST /staff` → tambah data pegawai (pihak1, pihak2, saksi)
    3. `POST /koleksi` → tambah data koleksi
    4. `POST /berita-acara` → buat BA (otomatis update kondisi & lokasi koleksi)
    5. `GET /berita-acara/:id` → lihat detail lengkap BA untuk cetak PDF
  version: "2.1.0"

servers:
  - url: http://localhost:5000/api
    description: Local Development
  - url: https://your-production-url.com/api
    description: Production

tags:
  - name: Auth
    description: Registrasi, Login, info pengguna
  - name: Staff
    description: Data pegawai museum (pihak pertama, kedua, saksi-saksi)
  - name: Koleksi
    description: Manajemen data koleksi museum
  - name: Berita Acara
    description: Pencatatan Berita Acara Pengembalian / Serah Terima koleksi

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:

    # ── Generics ───────────────────────────────────────────────────────────────
    SuccessResponse:
      type: object
      properties:
        success: { type: boolean, example: true }
        message: { type: string }
        data:    {}

    ErrorResponse:
      type: object
      properties:
        success: { type: boolean, example: false }
        message: { type: string }

    PaginationMeta:
      type: object
      properties:
        total:      { type: integer, example: 52 }
        page:       { type: integer, example: 1 }
        limit:      { type: integer, example: 20 }
        totalPages: { type: integer, example: 3 }

    # ── Auth ──────────────────────────────────────────────────────────────────
    UserPublic:
      type: object
      properties:
        id:         { type: string, format: uuid }
        nama:       { type: string, example: "Budi Santoso" }
        username:   { type: string, example: "budi.santoso" }
        role:       { type: string, enum: [admin, petugas] }
        created_at: { type: string, format: date-time }

    RegisterRequest:
      type: object
      required: [nama, username, password]
      properties:
        nama:     { type: string, example: "Budi Santoso" }
        username: { type: string, example: "budi.santoso" }
        password: { type: string, example: "password123", minLength: 6 }
        role:     { type: string, enum: [admin, petugas], default: petugas }

    LoginRequest:
      type: object
      required: [username, password]
      properties:
        username: { type: string, example: "budi.santoso" }
        password: { type: string, example: "password123" }

    # ── Staff ─────────────────────────────────────────────────────────────────
    Staff:
      type: object
      description: >
        Data pegawai yang digunakan sebagai pihak pertama, pihak kedua,
        atau saksi-saksi dalam Berita Acara.
      properties:
        id:         { type: string, format: uuid }
        nama:       { type: string, example: "Erni Mahdalena, S.Sos" }
        nip:        { type: string, example: "19830321 200504 2 002" }
        jabatan:    { type: string, example: "Kepala Seksi Preparasi dan Konsevasi" }
        alamat:     { type: string, example: "Museum Aceh" }
        created_at: { type: string, format: date-time }

    StaffRequest:
      type: object
      required: [nama, nip, jabatan]
      properties:
        nama:    { type: string, example: "Erni Mahdalena, S.Sos" }
        nip:     { type: string, example: "19830321 200504 2 002" }
        jabatan: { type: string, example: "Kepala Seksi Preparasi dan Konsevasi" }
        alamat:  { type: string, example: "Museum Aceh", default: "Museum Aceh" }

    StaffSummary:
      type: object
      description: Info staff ringkas untuk tampilan dokumen BA
      properties:
        nama:    { type: string }
        nip:     { type: string }
        jabatan: { type: string }

    StaffFull:
      type: object
      description: Info staff lengkap (termasuk alamat) untuk header dokumen BA
      properties:
        nama:    { type: string }
        nip:     { type: string }
        jabatan: { type: string }
        alamat:  { type: string }

    # ── Koleksi ───────────────────────────────────────────────────────────────
    Koleksi:
      type: object
      description: >
        Data koleksi sesuai Lampiran Data Koleksi pada dokumen Berita Acara.
        Kolom: No. Inventaris | Nama Koleksi | Jenis Koleksi | Kondisi
      properties:
        id:              { type: string, format: uuid }
        no_inventaris:   { type: string, example: "03.00243.00" }
        nama_koleksi:    { type: string, example: "Baju Sekulat Pria Alas" }
        jenis_koleksi:   { type: string, example: "Etnografika" }
        kondisi_terkini:
          type: string
          enum: [Baik, Rusak Ringan, Rusak Berat]
          example: Baik
        lokasi_terkini:  { type: string, example: "Ruang Penyimpanan Koleksi" }
        created_at:      { type: string, format: date-time }

    KoleksiRequest:
      type: object
      required: [no_inventaris, nama_koleksi]
      properties:
        no_inventaris:
          type: string
          example: "03.00243.00"
          description: Nomor inventaris unik (format sesuai standar museum)
        nama_koleksi:
          type: string
          example: "Baju Sekulat Pria Alas"
        jenis_koleksi:
          type: string
          example: "Etnografika"
        kondisi_terkini:
          type: string
          enum: [Baik, Rusak Ringan, Rusak Berat]
          default: Baik
        lokasi_terkini:
          type: string
          example: "Ruang Penyimpanan Koleksi"

    # ── Berita Acara ──────────────────────────────────────────────────────────
    BAItemRequest:
      type: object
      required: [koleksi_id, kondisi]
      properties:
        koleksi_id:
          type: string
          format: uuid
          description: UUID koleksi dari tabel koleksi
        kondisi:
          type: string
          enum: [Baik, Rusak Ringan, Rusak Berat]
          example: Baik
          description: Kondisi koleksi saat transaksi (akan di-update ke tabel koleksi)
        lokasi_tujuan:
          type: string
          example: "Ruang Penyimpanan Koleksi"
          description: Lokasi tujuan (akan di-update ke koleksi.lokasi_terkini)
        keterangan:
          type: string
          example: "Setelah dikonservasi"

    BACreateRequest:
      type: object
      required: [nomor_surat, jenis_ba, tanggal_serah_terima, pihak_pertama_id, pihak_kedua_id, items]
      properties:
        nomor_surat:
          type: string
          example: "02/PENG/II/2026"
        jenis_ba:
          type: string
          enum: [Pengembalian, Peminjaman, Serah Terima, Pengiriman]
          example: Pengembalian
        tanggal_serah_terima:
          type: string
          format: date
          example: "2026-02-13"
        pihak_pertama_id:
          type: string
          format: uuid
          description: ID staff — pihak yang MENYERAHKAN koleksi
        pihak_kedua_id:
          type: string
          format: uuid
          description: ID staff — pihak yang MENERIMA koleksi
        saksi1_id:
          type: string
          format: uuid
          description: ID staff saksi pertama (opsional)
        saksi2_id:
          type: string
          format: uuid
          description: ID staff saksi kedua (opsional)
        items:
          type: array
          minItems: 1
          items: { $ref: '#/components/schemas/BAItemRequest' }

    BAItemDetail:
      type: object
      description: Item koleksi dalam BA — sesuai baris tabel Lampiran Data Koleksi
      properties:
        id:                     { type: string, format: uuid }
        kondisi_saat_transaksi: { type: string }
        lokasi_tujuan:          { type: string }
        keterangan_item:        { type: string }
        koleksi:
          type: object
          properties:
            no_inventaris:   { type: string, example: "03.00243.00" }
            nama_koleksi:    { type: string, example: "Baju Sekulat Pria Alas" }
            jenis_koleksi:   { type: string, example: "Etnografika" }
            kondisi_terkini: { type: string, example: "Baik" }

    BADetail:
      type: object
      description: >
        Detail lengkap Berita Acara sesuai format dokumen resmi.
        Mencakup header, info pihak 1 & 2, saksi-saksi, dan lampiran koleksi.
      properties:
        id:                   { type: string, format: uuid }
        nomor_surat:          { type: string, example: "02/PENG/II/2026" }
        jenis_ba:             { type: string, example: "Pengembalian" }
        tanggal_serah_terima: { type: string, format: date, example: "2026-02-13" }
        created_at:           { type: string, format: date-time }
        pihak1:               { $ref: '#/components/schemas/StaffFull' }
        pihak2:               { $ref: '#/components/schemas/StaffFull' }
        saksi1:               { $ref: '#/components/schemas/StaffSummary' }
        saksi2:               { $ref: '#/components/schemas/StaffSummary' }
        items:
          type: array
          items: { $ref: '#/components/schemas/BAItemDetail' }

security:
  - BearerAuth: []

paths:

  # ════════════════════════════════════════════════════════════════════════════
  # AUTH
  # ════════════════════════════════════════════════════════════════════════════
  /auth/register:
    post:
      tags: [Auth]
      summary: Registrasi pengguna baru
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/RegisterRequest' }
      responses:
        '201': { description: Registrasi berhasil }
        '400': { description: Data tidak lengkap }
        '409': { description: Username sudah digunakan }

  /auth/login:
    post:
      tags: [Auth]
      summary: Login dan dapatkan JWT token
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/LoginRequest' }
      responses:
        '200':
          description: Login berhasil — salin `token` dari response
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          user:  { $ref: '#/components/schemas/UserPublic' }
                          token: { type: string }
        '401': { description: Username atau password salah }

  /auth/me:
    get:
      tags: [Auth]
      summary: Info pengguna yang sedang login
      responses:
        '200': { description: Data pengguna }

  # ════════════════════════════════════════════════════════════════════════════
  # STAFF
  # ════════════════════════════════════════════════════════════════════════════
  /staff:
    get:
      tags: [Staff]
      summary: Daftar semua staff
      parameters:
        - in: query
          name: jabatan
          schema: { type: string }
          description: Filter berdasarkan jabatan (exact match)
        - in: query
          name: q
          schema: { type: string }
          description: Cari berdasarkan nama (partial match)
        - in: query
          name: page
          schema: { type: integer, default: 1 }
        - in: query
          name: limit
          schema: { type: integer, default: 50 }
      responses:
        '200':
          description: Daftar staff
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          data:
                            type: array
                            items: { $ref: '#/components/schemas/Staff' }
                          meta: { $ref: '#/components/schemas/PaginationMeta' }

    post:
      tags: [Staff]
      summary: Tambah data staff baru (Admin & Petugas)
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/StaffRequest' }
            example:
              nama: "Erni Mahdalena, S.Sos"
              nip: "19830321 200504 2 002"
              jabatan: "Kepala Seksi Preparasi dan Konsevasi"
              alamat: "Museum Aceh"
      responses:
        '201': { description: Staff berhasil ditambahkan }
        '409': { description: NIP sudah terdaftar }

  /staff/{id}:
    parameters:
      - in: path
        name: id
        required: true
        schema: { type: string, format: uuid }

    get:
      tags: [Staff]
      summary: Detail satu staff
      responses:
        '200': { description: Data staff }
        '404': { description: Staff tidak ditemukan }

    put:
      tags: [Staff]
      summary: Update data staff
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/StaffRequest' }
      responses:
        '200': { description: Staff berhasil diperbarui }
        '404': { description: Staff tidak ditemukan }

    delete:
      tags: [Staff]
      summary: Hapus staff (Admin only)
      responses:
        '200': { description: Staff berhasil dihapus }
        '403': { description: Tidak memiliki izin }

  # ════════════════════════════════════════════════════════════════════════════
  # KOLEKSI
  # ════════════════════════════════════════════════════════════════════════════
  /koleksi:
    get:
      tags: [Koleksi]
      summary: Daftar koleksi dengan filter dinamis
      description: >
        Atribut koleksi sesuai Lampiran Data Koleksi pada dokumen BA:
        No. Inventaris | Nama Koleksi | Jenis Koleksi | Kondisi
      parameters:
        - in: query
          name: jenis_koleksi
          schema: { type: string }
          example: Etnografika
        - in: query
          name: kondisi_terkini
          schema:
            type: string
            enum: [Baik, Rusak Ringan, Rusak Berat]
        - in: query
          name: lokasi_terkini
          schema: { type: string }
        - in: query
          name: q
          schema: { type: string }
          description: Pencarian di nama_koleksi
        - in: query
          name: page
          schema: { type: integer, default: 1 }
        - in: query
          name: limit
          schema: { type: integer, default: 20 }
        - in: query
          name: sort_by
          schema: { type: string, default: no_inventaris }
        - in: query
          name: sort_order
          schema: { type: string, enum: [asc, desc], default: asc }
      responses:
        '200':
          description: Daftar koleksi
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          data:
                            type: array
                            items: { $ref: '#/components/schemas/Koleksi' }
                          meta: { $ref: '#/components/schemas/PaginationMeta' }

    post:
      tags: [Koleksi]
      summary: Tambah koleksi baru
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/KoleksiRequest' }
            example:
              no_inventaris: "03.00243.00"
              nama_koleksi: "Baju Sekulat Pria Alas"
              jenis_koleksi: "Etnografika"
              kondisi_terkini: "Baik"
              lokasi_terkini: "Ruang Penyimpanan Koleksi"
      responses:
        '201': { description: Koleksi berhasil ditambahkan }
        '409': { description: No. inventaris sudah digunakan }

  /koleksi/{id}:
    parameters:
      - in: path
        name: id
        required: true
        schema: { type: string, format: uuid }

    get:
      tags: [Koleksi]
      summary: Detail satu koleksi
      responses:
        '200': { description: Data koleksi }
        '404': { description: Koleksi tidak ditemukan }

    put:
      tags: [Koleksi]
      summary: Update koleksi
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/KoleksiRequest' }
      responses:
        '200': { description: Koleksi diperbarui }
        '404': { description: Koleksi tidak ditemukan }

    delete:
      tags: [Koleksi]
      summary: Hapus koleksi (Admin only)
      responses:
        '200': { description: Koleksi dihapus }
        '403': { description: Tidak memiliki izin }

  # ════════════════════════════════════════════════════════════════════════════
  # BERITA ACARA
  # ════════════════════════════════════════════════════════════════════════════
  /berita-acara:
    get:
      tags: [Berita Acara]
      summary: Daftar semua Berita Acara
      responses:
        '200':
          description: List BA dengan info singkat pihak 1 & 2

    post:
      tags: [Berita Acara]
      summary: Buat Berita Acara baru (transaksi)
      description: |
        Satu request ini melakukan **3 operasi sekaligus**:
        1. ✅ Insert header ke tabel `berita_acara`
        2. ✅ Insert semua item ke tabel `ba_items`
        3. ✅ **Auto-update** `kondisi_terkini` dan `lokasi_terkini` di tabel `koleksi`

        Jika salah satu gagal → **seluruh operasi di-rollback otomatis**.

        ### Persiapan sebelum membuat BA:
        - Pastikan data **staff** sudah diisi (untuk pihak1, pihak2, saksi1, saksi2)
        - Pastikan data **koleksi** sudah ada (untuk koleksi_id di items)
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/BACreateRequest' }
            example:
              nomor_surat: "02/PENG/II/2026"
              jenis_ba: "Pengembalian"
              tanggal_serah_terima: "2026-02-13"
              pihak_pertama_id: "uuid-erni-mahdalena"
              pihak_kedua_id: "uuid-nurhasanah"
              saksi1_id: "uuid-nurhawani"
              saksi2_id: "uuid-rahmi-novianti"
              items:
                - koleksi_id: "uuid-koleksi-1"
                  kondisi: "Baik"
                  lokasi_tujuan: "Ruang Penyimpanan Koleksi"
                - koleksi_id: "uuid-koleksi-2"
                  kondisi: "Rusak Ringan"
                  lokasi_tujuan: "Ruang Penyimpanan Koleksi"
                  keterangan: "Robek bagian ketiak"
      responses:
        '201':
          description: Berita Acara berhasil dibuat
        '400':
          description: Validasi gagal (field wajib kosong / items kosong / jenis_ba tidak valid)
        '500':
          description: Transaksi gagal dan otomatis di-rollback

  /berita-acara/{id}:
    get:
      tags: [Berita Acara]
      summary: Detail lengkap BA untuk preview/cetak PDF
      description: |
        Mengembalikan data lengkap sesuai struktur dokumen resmi:
        - Info **Pihak Pertama** (nama, NIP, jabatan, alamat)
        - Info **Pihak Kedua** (nama, NIP, jabatan, alamat)
        - Info **Saksi 1 & 2** (nama, NIP, jabatan)
        - **Lampiran Daftar Koleksi** (no_inventaris, nama, jenis, kondisi)
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200':
          description: Detail lengkap Berita Acara
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data: { $ref: '#/components/schemas/BADetail' }
        '404': { description: Berita Acara tidak ditemukan }